<?php
// $Id: reglang.module,v 1.1.2.6 2009/03/11 23:45:34 karst Exp $

/**
 * @file
 * Registration Language module file
 *
 * A helper Module that tries to circumvent some Drupal language behaviour problems.
 *
 */

define('REGLANG_REGISTER_OFF', 0);
define('REGLANG_REGISTER_CURRENT', 1);
define('REGLANG_REGISTER_DEFAULT', 2);

define('REGLANG_NOTIFY_OFF', 0);
define('REGLANG_NOTIFY_USER', 1);
define('REGLANG_NOTIFY_DEFAULT', 2);

/**
 * Implementation of hook_menu().
 */
function reglang_menu() {
  $items = array();

  $items['admin/user/reglang'] = array(
    'title' => 'Registration Language',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('reglang_settings'),
    'access arguments' => array('administer users'),
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;

}

/**
 * Administtration form
 */
function reglang_settings() {

  $form['reglang'] = array(
    '#value' => t('This is a helper Module that tries to circumvent some Drupal language behaviour problems.'),
  );

  $form['reglang_option'] = array(
    '#type' => 'radios',
    '#title' => t('The language if a user uses the sites registration process should be'),
    '#default_value' => variable_get('reglang_option', REGLANG_REGISTER_OFF),
    '#options' => array(
      t('None - This is default Drupal behaviour.'),
      t('Current - Current language of the site. Probably what you want.'),
      t('Default - Default language of the site.'),
    ),
  );

 $form['reglang_notify_option'] = array(
    '#type' => 'radios',
    '#title' => t('The language used to mails in if a user is set'),
    '#default_value' => variable_get('reglang_notify_option', REGLANG_NOTIFY_OFF),
    '#options' => array(
      t('Do nothing - Drupal default behaviour.'),
      t('Current - Language of the user the mail is for. Probably what you want.'),
      t('Default - Default language of the site.'),
    ),
  );

  return system_settings_form($form);
}


/**
 * Implementation of hook_user().
 */
function reglang_user($op, &$edit, &$account, $category = NULL) {
  //If no language already set and operation is insert
  if (!$account->language && $op == 'insert') {
    switch (variable_get('reglang_option', REGLANG_REGISTER_OFF)) {
      //current
      case REGLANG_REGISTER_CURRENT:
        global $language;
        break;
      //sites default
      case REGLANG_REGISTER_DEFAULT:
        $language = language_default();
        break;
      //default means do nothing
      case REGLANG_REGISTER_OFF:
      default:
        return;
    }
    db_query('UPDATE {users} SET language = "%s" WHERE uid = %d', $language->language, $account->uid);
  }
}

/**
 * Implementation of hook_mail_alter().
 */
function reglang_mail_alter(&$message) {
  //only check if the mail contains a user object
  if (isset($message['params']['account'])) {
    switch (variable_get('reglang_notify_option', REGLANG_NOTIFY_OFF)) {

      case REGLANG_NOTIFY_USER:
        //might already be the preferred language of the user but any way we have to load the language
        //so checking is equal to setting.
        $message['language'] = user_preferred_language($message['params']['account']);
        reglang_do_mail_edit($message);
        break;

      case REGLANG_NOTIFY_DEFAULT:
        $message['language'] = language_default();
        reglang_do_mail_edit($message);
        break;

      case REGLANG_NOTIFY_OFF:
      default:
        break;
    }
  }
}

/**
 * Helper function to check for and use the mail_edit module
 * mail_edit uses the same hook.
 * The functions are used in alphabetical order.
 * So I have to call the hook again to get the correct email.
 *
 * If a lot of mails are send I try to keep the check for mail_edit as small as possible.
 * This still might be a performance decrease.
 */
function reglang_do_mail_edit(&$message) {

  static $mail_edit_exists = NULL;

  if ($mail_edit_exists === NULL) {
    $mail_edit_exists = module_exists('mail_edit');
  }

  if ($mail_edit_exists) {
    mail_edit_mail_alter($message);
  }
}